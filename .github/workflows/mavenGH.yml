name: Deploy GitHub Pages and Allure Report

on:
  push:
    branches:
      - IAT-4

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Verify Java version
        run: java -version

      - name: Run Tests
        run: mvn clean test -DskipTests

      - name: Generate Allure Report
        run: mvn allure:report

      - name: Verify Environment Properties File
        run: ls -l allure-results/environment.properties

      - name: Upload Allure Results
        uses: actions/upload-artifact@v2
        with:
          name: allure-results
          path: allure-results

  deploy:
    runs-on: windows-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Allure CLI
        run: npm install -g allure-commandline

      - name: Generate Allure Report HTML
        run: |
          allure generate allure-results --clean -o allure-report
          ls -l allure-report  # Optional: List files in allure-report for verification

      - name: Deploy to GitHub Pages
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}  # GitHub token with repo scope
        run: |
          # Clone the gh-pages branch where GitHub Pages site is hosted
          git clone --branch gh-pages https://github.com/SohamQAKrish/Bateel_Automation.git gh-pages
          
          # Clean the existing contents of the gh-pages branch
          cd gh-pages
          git rm -rf .

          # Copy the Allure report files into the gh-pages branch
          cp -r ../allure-report/* .

          # Configure Git user details
          git config --global user.email "kashyap.dave@krishtechnolabs.com"
          git config --global user.name "KashyapDave95"

          # Add, commit, and push the changes to gh-pages branch
          git add .
          git commit -m "Deploy Allure report and GitHub Pages"
          git push origin gh-pages
